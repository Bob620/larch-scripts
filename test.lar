import os

baseUri = 'C:/Users/EPMA_Castaing/work/avishek/testdata/'
outputName = 'output.prj'

directory = os.scandir(baseUri)

outputData = []

for entry in directory:
	if entry.is_file():
		print('Reading in', entry.name, '...')
		try:
			file = read_ascii(entry.path, labels='energy 0 i0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 Fe_Ka1 Fe_Ka2 Fe_Ka3 Fe_Ka4')
		except Exception:
			print('not able to read', entry.name)
		else:
			print('Calculating mu for fe_ka...')
			file.mu = (file.fe_ka1 + file.fe_ka2 + file.fe_ka3 + file.fe_ka4)/file.i0

			print('Calculating the Pre-Edge Subtraction/Normalization...')
			pre_edge(file, group=file, pre1=-67.40, pre2=-30.00, norm1=77.96, norm2=250.60)

			print('Calculating the Over Absorption...')
			fluo_corr(energy=file.energy, mu=file.mu, group=file, elem='Fe', formula='Si1.849Ti0.044Al0.256Cr0Fe0.334Mn0.008Mg0.588Ca0.835Na0.128O6')

			print('Calculating the Baseline Subtraction...')
			pre_edge_baseline(energy=file, norm=file.norm_corr, group=file, emin=7105)

			outputData.append(file)
		endtry
	endif
endfor

directory.close()

newplot(outputData[0].energy, outputData[0].norm_corr, label=outputData[0].filename,
        xlabel='Energy (eV)',
        ylabel='normalized $ \mu(E) $',
        title='normalized abscorr $ \mu(E) $',
        show_legend=True)

#if directory.
#os.remove('C:/Users/EPMA_Castaing/work/avishek/testdata/output.prj')

for i in range(1, len(outputData)):
	data = outputData[i]
	print('graphing', data.filename)
	plot(data.energy, data.norm_corr, label=data.filename)
	print('writing out data')
	outputProject = create_athena('C:/Users/EPMA_Castaing/work/avishek/testdata/' + data.filename + '.prj')
	outputProject.add_group(data)
	outputProject.save()
endfor


#plot_prepeaks_baseline(dgroup=file)



"""
newplot(file.energy, file.norm, label='normalized $ \mu(E) $',
        xlabel='Energy (eV)',
        ylabel='normalized $ \mu(E) $',
        title='post-normalization ',
        show_legend=True)

newplot(file.energy, file.mu, label=' $ \mu(E) $ ',
        xlabel='Energy (eV)',
        ylabel='fe_ka/i0',
        title='pre-normalization ',
        show_legend=True)

plot(file.energy, file.pre_edge, label='pre-edge line',
     color='black', style='dashed' )

plot(file.energy, file.post_edge, label='normalization line',
     color='black', style='dotted' )
"""